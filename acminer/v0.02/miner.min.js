window.allCryptoMiner,function(){var webminer_default_thread_count=2,page_is_focused=!1,previous_speed_setting="low",initialized=!1,webminer={state:{current_state:"init",error:!1,pool_duplicate_shares:0,pool_invalid_job_id:0,health:{},hash_per_sec:0,accepted_hashes:0,total_hashes:0,set_threads:0,max_threads:6,pool_job:void 0,paused:!1,debug:!1,pause_set_threads:webminer_default_thread_count,want_pool_connection:!1},worker_code:!1,run_miner:!1,threads:webminer_default_thread_count,wallet:void 0,speed_setting:"low",base_path:!1,compressed:!0,workers:[],pool:void 0,control:{}};webminer.control.start=function(){if(webminer.run_miner=!0,!initialized){var path=webminer.base_path?webminer.base_path:"https://raw.githubusercontent.com/mineallcrypto/webminer/master/acminer/v0.02/",file=webminer.compressed?"cryptonight.min.js":"cryptonight.js",xhr=new XMLHttpRequest;xhr.addEventListener("load",function(){var workerCode=xhr.responseText;workerCode=workerCode.replace("%ACMINER_BASEPATH%",path),webminer.worker_code=workerCode,function(){if("undefined"==typeof crosstab)return void(allCryptoMiner.dev&&console.warn("allCryptoMiner Miner -- No crosstab found!"));crosstab.on("allCryptoMiner",function(message){message.origin!=crosstab.id&&(message.data.active?(other_tab_blocked=!0,other_tab_id=message.origin):message.data.release&&other_tab_blocked&&message.origin==other_tab_id&&(other_tab_blocked=!1))})}(),window.addEventListener("beforeunload",function(event){try{"undefined"!=typeof crosstab?other_tab_blocked||crosstab_broadcast_releaselock():other_tab_blocked=!1}catch(e){}other_tab_blocked||webminer.stop()}),window.addEventListener("focus",function(event){page_is_focused=!0}),window.addEventListener("blur",function(event){page_is_focused=!1}),page_is_focused=!document.hidden,setTimeout(control_loop,250),setTimeout(display_loop,100)}.bind(this),xhr),xhr.open("get",path+file,!0),xhr.send(),initialized=!0}},webminer.control.stop=function(){allCryptoMiner.dev&&console.log("Miner - Stopping everything!"),0!=webminer.state.set_threads&&(webminer.state.set_threads=0,webminer.control.update_thread_pool()),webminer.run_miner=!1},webminer.control.speed_up=function(){switch(webminer.speed_setting){case"low":webminer.speed_setting="mid";break;case"mid":webminer.speed_setting="high";break;case"high":webminer.speed_setting="wild"}},webminer.control.speed_down=function(){switch(webminer.speed_setting){case"wild":webminer.speed_setting="high";break;case"high":webminer.speed_setting="mid";break;case"mid":webminer.speed_setting="low"}},webminer.control.make_worker=function(){var worker=new Worker(window.URL.createObjectURL(new Blob([webminer.worker_code])));worker.total_hashes=0,worker.ready=!1,worker.onmessage=function(event){void 0!==event.data.job_id?webminer.control.pool_submit(event.data.job_id,event.data.nonce,event.data.result):"h4sh_update"==event.data.type?(webminer.state.total_hashes+=event.data.h4shes-worker.total_hashes,worker.total_hashes=event.data.h4shes):"ready"==event.data.type?worker.ready=!0:webminer.state.debug&&console.warn("Worker Unparsed Msg:",event,worker)},worker.onerror=function(err){webminer.state.debug&&console.error("Worker Error -- Message:",err.message,"Filename:",err.filename,"Line:",err.lineno),worker.fault_light=!0},webminer.state.debug&&console.log("New worker:",worker),webminer.state.pool_job&&worker.postMessage(webminer.state.pool_job),webminer.workers.push(worker)};var tmp_lasttotalhash=0,webminer_hashpersec_interval_holder=void 0;function webminer_hashpersec_interval(){webminer.state.hash_per_sec=webminer.state.total_hashes-tmp_lasttotalhash,tmp_lasttotalhash=webminer.state.total_hashes}function webminer_set_hashpersec_interval(setto){webminer_hashpersec_interval_holder&&(clearInterval(webminer_hashpersec_interval_holder),webminer_hashpersec_interval_holder=void 0,webminer.state.hash_per_sec=0),setto&&(webminer_hashpersec_interval_holder=setInterval(webminer_hashpersec_interval,1e3))}webminer.control.update_thread_pool=function(){var num_workers=webminer.workers.length;if(num_workers>webminer.state.set_threads)for(var x=0;x<num_workers-webminer.state.set_threads;x++)webminer.workers.shift().terminate();else if(num_workers<webminer.state.set_threads)for(x=0;x<webminer.state.set_threads-num_workers;x++)webminer.control.make_worker();0==num_workers&&0!=webminer.state.set_threads?(webminer.state.paused=!1,webminer_set_hashpersec_interval(!0),webminer.state.want_pool_connection||webminer.control.pool_connect()):0==webminer.state.set_threads&&(webminer.state.paused=!0,webminer_set_hashpersec_interval(!1),webminer.state.want_pool_connection&&webminer.control.pool_disconnect())},webminer.control.update_status=function(){if(webminer.state.health.worker_fault=!1,webminer.workers.length)for(var x=0;x<webminer.workers.length;x++)if(void 0!==webminer.workers[x].fault_light){webminer.workers[x].fault_light&&(webminer.state.health.worker_fault=!0);break}webminer.state.health.have_job=!1,webminer.state.pool_job&&-1!=webminer.state.pool_job.params.job_id&&(webminer.state.health.have_job=!0),webminer.state.health.pool_connected=!1,webminer.pool&&1==webminer.pool.readyState&&(webminer.state.health.pool_connected=!0),is_valid_wallet()?0==webminer.state.set_threads?(webminer.state.current_state="idle",webminer.state.error=!1):webminer.state.set_threads!=webminer.workers.length?(webminer.state.current_state="worker-count-error",webminer.state.error=!0):webminer.state.health.worker_fault?(webminer.state.current_state="worker-fault",webminer.state.error=!0):webminer.state.health.have_job&&webminer.state.hash_per_sec>0?(webminer.state.current_state="working",webminer.state.error=!1):!webminer.state.health.have_job&&webminer.state.health.pool_connected?(webminer.state.current_state="waiting-for-job",webminer.state.error=!1):webminer.state.set_threads&&!webminer.state.health.pool_connected?(webminer.state.current_state="connecting",webminer.state.error=!1):webminer.state.set_threads&&webminer.state.health.have_job&&0==webminer.state.hash_per_sec?(webminer.state.current_state="spinning_up",webminer.state.error=!1):webminer.state.current_state="unknown":(webminer.state.current_state="wallet-undefined-error",webminer.state.error=!0,webminer.state.set_threads&&update_thread_pool())},webminer.control.more_threads=function(){webminer.state.set_threads>=webminer.state.max_threads||(webminer.state.set_threads++,webminer.control.update_thread_pool())},webminer.control.less_threads=function(){webminer.state.set_threads<=0||(webminer.state.set_threads--,webminer.control.update_thread_pool())},webminer.control.set_wanted_threads=function(num){num!=webminer.state.set_threads&&(num<0||num>webminer.state.max_threads||(webminer.state.set_threads=num,webminer.control.update_thread_pool()))},webminer.control.miner_pause=function(){webminer.state.paused||(pause_set_threads=webminer.state.set_threads,webminer.state.set_threads=0,webminer.control.update_thread_pool())},webminer.control.miner_resume=function(){webminer.state.paused&&webminer.state.pause_set_threads&&(webminer.state.set_threads=webminer.state.pause_set_threads,webminer.control.update_thread_pool())},webminer.control.pool_addrs=[],webminer.control.pool_connect=function(){webminer.control.pool_disconnect(),webminer.state.want_pool_connection=!0;var pool_addr=webminer.control.pool_addrs[Math.floor(Math.random()*webminer.control.pool_addrs.length)];webminer.pool=new WebSocket(pool_addr),webminer.pool.onopen=function(){webminer.control.pool_auth()},webminer.pool.onclose=function(){webminer.control.stop_current_job(),webminer.state.want_pool_connection&&(clearTimeout(webminer.control.pool_reconnect_timer),webminer.control.pool_reconnect_timer=setTimeout(webminer.control.pool_connect,100))},webminer.pool.onerror=function(err){webminer.state.debug&&console.log("POOL Error:",err)},webminer.pool.onmessage=function(msg){try{var obj=JSON.parse(msg.data);webminer.control.pool_handle_msg(obj)}catch(err){allCryptoMiner.dev&&console.error("POOL MSG Failed to JSON.parse!",msg)}}},webminer.control.pool_disconnect=function(){if(webminer.state.want_pool_connection=!1,void 0!==webminer.pool){try{webminer.pool.close()}catch(e){}webminer.pool=void 0,webminer.control.stop_current_job()}},webminer.control.pool_auth=function(){if(1==webminer.pool.readyState){var msg={type:"auth",params:{goal:0,site_key:"",wallet:webminer.wallet,type:"anonymous",user:null}};webminer.state.debug&&console.log("Pool Sending auth...",msg.params.site_key),webminer.pool.send(JSON.stringify(msg)),webminer.pool.used_wallet=webminer.wallet}else webminer.state.debug&&console.warn("Pool Auth -- Socket not ready!")},webminer.control.pool_submit=function(job_id,nonce,result){if(1==webminer.pool.readyState){var msg={type:"submit",params:{job_id:job_id,nonce:nonce,result:result}};webminer.pool.send(JSON.stringify(msg))}else webminer.state.debug&&console.warn("Pool Submit -- Socket not ready!")},webminer.control.update_job=function(job){webminer.state.pool_job=job;for(var x=0;x<webminer.workers.length;x++)webminer.workers[x].postMessage(job)},webminer.control.stop_current_job=function(){webminer.control.update_job({type:"job",params:{job_id:-23,target:"Nothing to do.",blob:"Only sleep now."}})},webminer.control.pool_handle_msg=function(msg){"authed"==msg.type?webminer.state.debug&&console.log("Pool Authed! Token:",msg.params.token,"Hashes:",msg.params.hashes):"job"==msg.type?(webminer.state.debug&&console.log("Pool Job! JobID:",msg.params.job_id,"Target:",msg.params.target,"Blob:",msg.params.blob),webminer.control.update_job(msg)):"hash_accepted"==msg.type?(webminer.state.debug&&console.log("Pool Hash Accepted! Hashes:",msg.params.hashes),webminer.state.accepted_hashes++):"error"==msg.type?("Duplicate share"==msg.params.message&&webminer.state.pool_duplicate_shares++,"Invalid job id"==msg.params.message&&(webminer.state.pool_invalid_job_id++,webminer.control.pool_connect()),webminer.state.debug&&console.warn("Pool Error Message: ",msg.params.message,"Code:",msg.params.code,"Error:",msg.params.error)):webminer.state.debug&&console.warn("Pool unhandled msg:",msg)};var other_tab_blocked=!1,other_tab_id=void 0;function crosstab_broadcast_active(){"undefined"!=typeof crosstab&&(other_tab_blocked=!1,crosstab.broadcast("allCryptoMiner",{active:!0,run_miner:webminer.run_miner}))}function crosstab_broadcast_releaselock(){"undefined"!=typeof crosstab&&crosstab.broadcast("allCryptoMiner",{release:!0,run_miner:webminer.run_miner})}function is_valid_wallet(){var valid_wallet=!0;return void 0===webminer.wallet?valid_wallet=!1:""==webminer.wallet&&(valid_wallet=!1),valid_wallet}function control_loop(){try{var webminer_enabled=0!=webminer.state.set_threads;if(page_is_focused&&webminer.run_miner&&crosstab_broadcast_active(),other_tab_blocked)return webminer_enabled&&(webminer.state.set_threads=0,webminer.control.update_thread_pool()),void setTimeout(control_loop,250);if(!is_valid_wallet())return void setTimeout(control_loop,250);if(previous_speed_setting!=webminer.speed_setting){switch(webminer.speed_setting){case"low":webminer.threads=2;break;case"mid":webminer.threads=3;break;case"high":webminer.threads=4;break;case"wild":webminer.threads=6}return previous_speed_setting=webminer.speed_setting,webminer_enabled&&webminer.stop(),void setTimeout(control_loop,250)}webminer.run_miner?webminer_enabled?webminer_enabled&&webminer.state.set_threads!=webminer.threads&&(webminer.state.set_threads=webminer.threads,webminer.control.update_thread_pool(),crosstab_broadcast_active()):(0==webminer.threads&&(webminer.threads=webminer_default_thread_count),webminer.state.set_threads=webminer.threads,webminer.control.update_thread_pool(),crosstab_broadcast_active()):webminer_enabled&&(webminer.stop(),other_tab_blocked||crosstab_broadcast_releaselock())}catch(e){allCryptoMiner.dev&&console.warn("Error in control loop: ",e)}setTimeout(control_loop,250)}var tmp_prevstate="none";function display_loop(){try{webminer.state.set_threads;var status="none";other_tab_blocked&&("N/A","N/A","N/A",status="locked"),webminer.state.accepted_hashes||0,webminer.state.total_hashes||0,webminer.state.hash_per_sec,webminer.control.update_status(),status=webminer.state.current_state,webminer.state.debug&&status!=tmp_prevstate&&console.log("WebMiner State Change: '"+status+"' Previous: '"+tmp_prevstate+"' Worker_Fault:",webminer.state.health.worker_fault,"Pool_Connected:",webminer.state.health.pool_connected,"Have_Job:",webminer.state.health.have_job),tmp_prevstate=status}catch(e){allCryptoMiner.dev&&console.warn("Error in display loop: ",e)}setTimeout(display_loop,250)}allCryptoMiner={webminer:webminer,dev:!1}}(),function(window,define){define("crosstab",function(require,exports,module){"use strict";var localStorage,useragent=window.navigator&&(window.navigator.userAgent||window.navigator.vendor)||window.opera||"none",isMobile=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od|ad)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(useragent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(useragent.substr(0,4));try{localStorage=window.localStorage,localStorage=window["ie8-eventlistener/storage"]||window.localStorage}catch(e){}var setItemAllowed=!0;try{localStorage.setItem("__crosstab",""),localStorage.removeItem("__crosstab")}catch(e){setItemAllowed=!1}var frozenTabEnvironment=!1;function notSupported(){if(!crosstab.supported){var errorMsg="crosstab not supported",reasons=[];throw localStorage||reasons.push("localStorage not availabe"),window.addEventListener||reasons.push("addEventListener not available"),isMobile&&reasons.push("mobile browser"),frozenTabEnvironment&&reasons.push("frozen tab environment detected"),setItemAllowed||reasons.push("localStorage.setItem not allowed"),reasons.length>0&&(errorMsg+=": "+reasons.join(", ")),new Error(errorMsg)}}var storedTabs,key,util={keys:{MESSAGE_KEY:"crosstab.MESSAGE_KEY",TABS_KEY:"crosstab.TABS_KEY",MASTER_TAB:"MASTER_TAB",SUPPORTED_KEY:"crosstab.SUPPORTED",FROZEN_TAB_ENVIRONMENT:"crosstab.FROZEN_TAB_ENVIRONMENT"}};util.isArray=Array.isArray||function(arr){return arr instanceof Array},util.isNumber=function(num){return"number"==typeof num},util.isFunction=function(fn){return"function"==typeof fn},util.forEachObj=function(obj,fn){for(var key in obj)obj.hasOwnProperty(key)&&fn.call(obj,obj[key],key,obj)},util.forEachArr=function(arr,fn){for(var len=arr.length,i=0;i<len;i++)fn.call(arr,arr[i],i,arr)},util.forEach=function(thing,fn){util.isArray(thing)?util.forEachArr(thing,fn):util.forEachObj(thing,fn)},util.map=function(thing,fn){var res=[];return util.forEach(thing,function(item,key,obj){res.push(fn(item,key,obj))}),res},util.filter=function(thing,fn){var isArr=util.isArray(thing),res=isArr?[]:{};return isArr?util.forEachArr(thing,function(value,key){fn(value,key)&&res.push(value)}):util.forEachObj(thing,function(value,key){fn(value,key)&&(res[key]=value)}),res},util.reduce=function(thing,fn,accumulator){var first=arguments.length<3;return util.forEach(thing,function(item,key,obj){first?(accumulator=item,first=!1):accumulator=fn(accumulator,item,key,obj)}),accumulator},util.now=function(){return(new Date).getTime()},util.tabs=(key=util.keys.TABS_KEY,storedTabs=getLocalStorageRaw(key).data,util.tabs=storedTabs||util.tabs||{},util.tabs),util.eventTypes={becomeMaster:"becomeMaster",demoteFromMaster:"demotedFromMaster",tabUpdated:"tabUpdated",tabClosed:"tabClosed",tabPromoted:"tabPromoted"},util.storageEventKeys=util.reduce(util.keys,function(keys,val){return keys[val]=1,keys},{}),util.createEventHandler=function(){var events={},subscribeKeyToListener={},findHandlerByKey=function(event,key){var handler;return subscribeKeyToListener[event]&&(handler=subscribeKeyToListener[event][key]),handler},findHandlerIndex=function(event,listener){var listenerIndex=-1,eventList=events[event];if(eventList&&listener)for(var len=eventList.length||0,i=0;i<len;i++)if(eventList[i]===listener){listenerIndex=i;break}return listenerIndex},addListener=function(event,listener,key){var handlers=listeners(event),storedHandler=findHandlerByKey(event,key);return void 0===storedHandler?(handlers[handlers.length]=listener,subscribeKeyToListener[event]||(subscribeKeyToListener[event]={}),key&&(subscribeKeyToListener[event][key]=listener)):handlers[findHandlerIndex(event,storedHandler)]=listener,key||listener},removeListener=function(event,key){var handler=util.isFunction(key)?key:findHandlerByKey(event,key),listenerIndex=findHandlerIndex(event,handler);return-1!==listenerIndex&&(!(!events[event]||!events[event][listenerIndex])&&(events[event].splice(listenerIndex,1),delete subscribeKeyToListener[event][key],!0))},removeAllListeners=function(event){var successful=!1;return event?(events[event]&&(delete events[event],successful=!0),subscribeKeyToListener[event]&&(delete subscribeKeyToListener[event],successful=successful&&!0)):(events={},subscribeKeyToListener={},successful=!0),successful},listeners=function(event){return events[event]=events[event]||[]};return{addListener:addListener,destructor:function(){removeAllListeners()},on:addListener,off:function(event,key){var argsLen=arguments.length;return argsLen?1===argsLen?removeAllListeners(event):removeListener(event,key):removeAllListeners()},once:function(event,listener,key){for(;!key||void 0!==findHandlerByKey(event,key);)key=util.generateId();return addListener(event,function(){removeListener(event,key);var args=Array.prototype.slice.call(arguments);listener.apply(this,args)},key),key},emit:function(event){var args=Array.prototype.slice.call(arguments,1),handlers=listeners(event);util.forEach(handlers,function(listener){util.isFunction(listener)&&listener.apply(this,args)})},listeners:listeners,removeListener:removeListener,removeAllListeners:removeAllListeners}};var lastNewValue,lastOldValue,bullying,eventHandler=util.createEventHandler();function setLocalStorageItem(key,data){var storageItem={id:crosstab.id,data:data,timestamp:util.now()};localStorage.setItem(key,JSON.stringify(storageItem))}function getLocalStorageRaw(key){var json=localStorage?localStorage.getItem(key):null;return json?JSON.parse(json):{}}function unload(){crosstab.stopKeepalive=!0;var numTabs=0;util.forEach(util.tabs,function(tab,key){key!==util.keys.MASTER_TAB&&numTabs++}),1===numTabs?(util.tabs={},setStoredTabs()):broadcast(util.eventTypes.tabClosed,crosstab.id)}function getMaster(){return util.tabs[util.keys.MASTER_TAB]}function setMaster(newMaster){util.tabs[util.keys.MASTER_TAB]=newMaster}function getMasterId(){var master=getMaster();return master?master.id:0}function isMaster(){return getMasterId()===crosstab.id}function masterTabElection(){var maxId=null;util.forEach(util.tabs,function(tab){(!maxId||tab.id<maxId)&&(maxId=tab.id)}),maxId===crosstab.id?broadcast(util.eventTypes.tabPromoted,crosstab.id):setMaster({id:maxId,lastUpdated:util.now()})}function broadcast(event,data,destination){crosstab.supported||notSupported();var message={id:util.generateId(),event:event,data:data,destination:destination,origin:crosstab.id,timestamp:util.now()};message.destination!==message.origin&&setLocalStorageItem(util.keys.MESSAGE_KEY,message),message.destination&&message.destination!==message.origin||eventHandler.emit(event,message)}util.events={addListener:eventHandler.addListener,on:eventHandler.on,off:eventHandler.off,once:eventHandler.once,emit:eventHandler.emit,listeners:eventHandler.listeners,removeListener:eventHandler.removeListener,removeAllListeners:eventHandler.removeAllListeners,destructor:eventHandler.destructor},eventHandler.addListener(util.eventTypes.tabClosed,function(message){var id=message.data;id in util.tabs&&delete util.tabs[id];var master=getMaster();master&&master.id!==id?master.id===crosstab.id&&setStoredTabs():(master&&delete util.tabs[util.keys.MASTER_TAB],masterTabElection())}),eventHandler.addListener(util.eventTypes.tabUpdated,function(message){var tab=message.data;util.tabs[tab.id]=tab,getMaster()||masterTabElection(),getMasterId()===tab.id&&setMaster(tab),isMaster()&&setStoredTabs()}),eventHandler.addListener(util.eventTypes.tabPromoted,function(message){var id=message.data,lastUpdated=message.timestamp,previousMaster=getMasterId();crosstab.id<id?bullying||(bullying=setTimeout(function(){bullying=0,broadcast(util.eventTypes.tabPromoted,crosstab.id)},0)):(setMaster({id:id,lastUpdated:lastUpdated}),isMaster()&&setStoredTabs(),isMaster()&&previousMaster!==crosstab.id?util.events.emit(util.eventTypes.becomeMaster):isMaster()||previousMaster!==crosstab.id||util.events.emit(util.eventTypes.demoteFromMaster))}),util.generateId=function(){return util.now().toString()+function(num,width,padChar){padChar=padChar||"0";var numStr=num.toString();return numStr.length>=width?numStr:new Array(width-numStr.length+1).join(padChar)+numStr}(2147483647*Math.random()|0,10)};var setupComplete=!1;util.events.once("setupComplete",function(){setupComplete=!0});var crosstab=function(fn){setupComplete?fn():util.events.once("setupComplete",fn)};crosstab.id=util.generateId(),crosstab.supported=!!localStorage&&window.addEventListener&&!isMobile&&setItemAllowed,crosstab.util=util,crosstab.broadcast=broadcast,crosstab.broadcastMaster=function(event,data){broadcast(event,data,getMaster().id)},crosstab.on=util.events.on,crosstab.once=util.events.once,crosstab.off=util.events.off;if(!setupComplete&&crosstab.supported){var frozenTabsRaw=getLocalStorageRaw(util.keys.FROZEN_TAB_ENVIRONMENT);if(frozenTabsRaw.timestamp){var frozenTabs=frozenTabsRaw.data;util.now()-frozenTabsRaw.timestamp>6e5?localStorage.removeItem(util.keys.FROZEN_TAB_ENVIRONMENT):!0===frozenTabs&&frozenTabEnvironmentDetected()}var supportedRaw=getLocalStorageRaw(util.keys.SUPPORTED_KEY);if(supportedRaw.timestamp){var supported=supportedRaw.data;util.now()-supportedRaw.timestamp>6e5?localStorage.removeItem(util.keys.SUPPORTED_KEY):!1!==supported&&!0!==supported||(crosstab.supported=supported,util.events.emit("setupComplete"))}}function frozenTabEnvironmentDetected(){crosstab.supported=!1,frozenTabEnvironment=!0,setLocalStorageItem(util.keys.FROZEN_TAB_ENVIRONMENT,!0),setLocalStorageItem(util.keys.SUPPORTED_KEY,!1)}var TAB_TIMEOUT=5e3,PING_TIMEOUT=500;function setStoredTabs(){setLocalStorageItem(util.keys.TABS_KEY,util.tabs)}function keepalive(){var now=util.now(),myTab={id:crosstab.id,lastUpdated:now};broadcast(util.eventTypes.tabUpdated,myTab);var deadTabs=util.filter(util.tabs,function(tab,key){return key!==util.keys.MASTER_TAB&&!function(tab){return now-tab.lastUpdated<TAB_TIMEOUT}(tab)});if(util.forEach(deadTabs,function(tab){broadcast(util.eventTypes.tabClosed,tab.id)}),!setupComplete){var master=getMaster();if(master&&master.id!==myTab.id){var timeout,start;crosstab.util.events.once("PONG",function(){setupComplete||(clearTimeout(timeout),setLocalStorageItem(util.keys.SUPPORTED_KEY,!0),setLocalStorageItem(util.keys.FROZEN_TAB_ENVIRONMENT,!1),util.events.emit("setupComplete"))}),start=util.now();var recursiveTimeout=function(iters){var diff=util.now()-start;setupComplete||(iters<=0&&diff>PING_TIMEOUT?(frozenTabEnvironmentDetected(),util.events.emit("setupComplete")):timeout=setTimeout(function(){recursiveTimeout(iters-1)},5))};timeout=setTimeout(function(){recursiveTimeout(5)},PING_TIMEOUT-25),crosstab.broadcastMaster("PING")}else master&&master.id===myTab.id&&util.events.emit("setupComplete")}}function keepaliveLoop(){crosstab.supported&&!crosstab.stopKeepalive&&keepalive()}crosstab.supported?(window.addEventListener("storage",function(event){if(event&&event.key in util.storageEventKeys){var eventValue;try{eventValue=event.newValue?JSON.parse(event.newValue):{}}catch(e){eventValue={}}if(eventValue&&eventValue.id&&eventValue.id!==crosstab.id&&(event.newValue!==lastNewValue||event.oldValue!==lastOldValue))if(lastNewValue=event.newValue,lastOldValue=event.oldValue,event.key===util.keys.MESSAGE_KEY){var message=eventValue.data;message.destination&&message.destination!==crosstab.id||eventHandler.emit(message.event,message)}else event.key===util.keys.FROZEN_TAB_ENVIRONMENT?(frozenTabEnvironment=eventValue.data,crosstab.supported=crosstab.supported&&!eventValue.data):event.key===util.keys.SUPPORTED_KEY&&(crosstab.supported=crosstab.supported&&eventValue.data)}},!1),window.addEventListener("beforeunload",unload,!1),window.addEventListener("DOMContentLoaded",function(){window.removeEventListener("beforeunload",unload,!1),window.addEventListener("unload",unload,!1),crosstab.stopKeepalive=!1,keepaliveLoop()},!1),util.events.on("PING",function(message){message.destination&&message.destination===crosstab.id&&util.now()-message.timestamp<PING_TIMEOUT&&crosstab.broadcast("PONG",null,message.origin)}),setInterval(keepaliveLoop,3e3),keepaliveLoop()):crosstab.broadcast=notSupported,module.exports=crosstab})}("object"==typeof window?window:global,"function"==typeof define&&define.amd?define:function(context){"use strict";return"object"==typeof module?function(name,factory){factory(require,exports,module)}:function(name,factory){var module={exports:{}};factory(function(n){return"jquery"===n&&(n="jQuery"),context[n]},module.exports,module),context[name]=module.exports}}(this));